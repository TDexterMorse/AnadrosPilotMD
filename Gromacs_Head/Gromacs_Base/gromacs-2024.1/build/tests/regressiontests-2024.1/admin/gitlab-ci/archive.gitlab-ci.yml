# Packages, exported artifacts, and release engineering processes.

# Special job to package regressiontest files and have them available for testing
# Runs during pre-build
# Set up to only fetch the files and prepare everything for merge requests
gromacs:prepare:
  extends:
    - .variables:default
    - .rules:merge-requests
  cache: {}
  image: ${CI_REGISTRY}/gromacs/gromacs/ci-ubuntu-20.04-llvm-7-docs
  stage: pre-build

  variables:
    KUBERNETES_CPU_LIMIT: 1
    KUBERNETES_CPU_REQUEST: 1
    KUBERNETES_MEMORY_REQUEST: 2Gi
  # Always clone the default version for this branch, main in this case
  script:
    - export SOURCEBRANCH=release-2024
    - if [[ ! -z $GROMACSSOURCEBRANCH ]] ; then
      export SOURCEBRANCH=$GROMACSSOURCEBRANCH ;
      echo "Using $SOURCEBRANCH instead of default" ;
      fi
    - export CHECKOUTCOMMIT=FETCH_HEAD
    - if [[ ! -z $GROMACSSOURCECOMMIT ]] ; then
      export CHECKOUTCOMMIT=$GROMACSSOURCECOMMIT ;
      echo "Using $CHECKOUTCOMMIT instead of head of $SOURCEBRANCH" ;
      fi
    - if [[ ! -d gromacs ]] ; then
        mkdir gromacs ;
        cd gromacs ;
        git init ;
        cd .. ;
      fi
    - cd gromacs
    - git fetch https://gitlab.com/gromacs/gromacs.git $SOURCEBRANCH
    - git checkout -qf $CHECKOUTCOMMIT
    - git clean -ffdxq
    - git gc
    - git archive -o gmx-source.tar.gz --prefix gromacs/ -9 HEAD
    - echo "Build source for branch $SOURCEBRANCH"
    - mv gmx-source.tar.gz ..
    - cd ..
  artifacts:
    paths:
      - gmx-source.tar.gz
